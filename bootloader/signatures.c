/*
 * This file is part of the TREZOR project, https://trezor.io/
 *
 * Copyright (C) 2014 Pavol Rusnak <stick@satoshilabs.com>
 *
 * This library is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This library is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this library.  If not, see <http://www.gnu.org/licenses/>.
 */

#include <stdint.h>
#include <string.h>

#include "signatures.h"
#include "ecdsa.h"
#include "secp256k1.h"
#include "sha2.h"
#include "bootloader.h"

#define PUBKEYS 5

static const uint8_t *pubkey[PUBKEYS] = {
	(uint8_t *)"\x04\x1E\x61\xD0\x82\x4D\x98\x96\xF5\x7B\x6D\x5D\x0B\xC5\x3B\x6E\x72\xA7\xD7\xCD\xFA\x92\xF3\xAF\x4B\x48\x91\x69\x89\x39\x13\x0B\x41\x87\x9D\x98\xB9\xE0\x24\xE4\xEA\xF3\xB1\x54\xDE\xB2\x14\x99\x27\xA0\x7C\xF2\x3C\x43\x40\xB8\xD2\xDD\x5F\xD5\x95\xDF\xC7\x13\x71",
    (uint8_t *)"\x04\x8E\xF5\x45\xED\x4C\xE4\xED\xE4\x23\x1D\xAF\xBF\xE5\x10\xFC\xE5\xC7\x5A\xBF\xBC\x98\xD9\x94\x59\xA4\xF8\x75\xD5\x68\x5D\x31\xE5\x91\x12\xA3\x87\x42\xA1\x00\x2E\xE4\xBB\x98\xA0\x97\xBE\x41\xDB\xAF\xC1\x70\x44\xC9\x14\x19\x2B\x9B\xA8\x8F\x28\xF7\x5B\x28\x44",
    (uint8_t *)"\x04\x8E\xF5\x45\xED\x4C\xE4\xED\xE4\x23\x1D\xAF\xBF\xE5\x10\xFC\xE5\xC7\x5A\xBF\xBC\x98\xD9\x94\x59\xA4\xF8\x75\xD5\x68\x5D\x31\xE5\x91\x12\xA3\x87\x42\xA1\x00\x2E\xE4\xBB\x98\xA0\x97\xBE\x41\xDB\xAF\xC1\x70\x44\xC9\x14\x19\x2B\x9B\xA8\x8F\x28\xF7\x5B\x28\x44",
    
	// (uint8_t *)"\x04\x56\x01\x57\x0c\xb4\x7f\x23\x8d\x2b\x02\x86\xdb\x4a\x99\x0f\xa0\xf3\xba\x28\xd1\xa3\x19\xf5\xe7\xcf\x55\xc2\xa2\x44\x4d\xa7\xcc\xc1\x36\xc1\xdc\x0c\xbe\xb9\x30\xe9\xe2\x98\x04\x35\x89\x35\x1d\x81\xd8\xe0\xbc\x73\x6a\xe2\xa1\xf5\x19\x2e\x5e\x8b\x06\x1d\x58",
	// (uint8_t *)"\x04\x2b\x4e\xa0\xa7\x97\xa4\x43\xd2\x93\xef\x5c\xff\x44\x4f\x49\x79\xf0\x6a\xcf\xeb\xd7\xe8\x6d\x27\x74\x75\x65\x61\x38\x38\x5b\x6c\x85\xe8\x9b\xc0\x37\x94\x5d\x93\xb3\x43\x08\x3b\x5a\x1c\x86\x13\x1a\x01\xf6\x0c\x50\x26\x97\x63\xb5\x70\xc8\x54\xe5\xc0\x9b\x7a",
	// (uint8_t *)"\x04\x4c\xe1\x19\xc9\x6e\x2f\xa3\x57\x20\x0b\x55\x9b\x2f\x7d\xd5\xa5\xf0\x2d\x52\x90\xaf\xf7\x4b\x03\xf3\xe4\x71\xb2\x73\x21\x1c\x97\x12\xba\x26\xdc\xb1\x0e\xc1\x62\x5d\xa6\x1f\xa1\x0a\x84\x4c\x67\x61\x62\x94\x82\x71\xd9\x69\x67\x45\x02\x88\xee\x92\x33\xdc\x3a",
	(uint8_t *)"\x04\x56\x01\x57\x0c\xb4\x7f\x23\x8d\x2b\x02\x86\xdb\x4a\x99\x0f\xa0\xf3\xba\x28\xd1\xa3\x19\xf5\xe7\xcf\x55\xc2\xa2\x44\x4d\xa7\xcc\xc1\x36\xc1\xdc\x0c\xbe\xb9\x30\xe9\xe2\x98\x04\x35\x89\x35\x1d\x81\xd8\xe0\xbc\x73\x6a\xe2\xa1\xf5\x19\x2e\x5e\x8b\x06\x1d\x58",
	(uint8_t *)"\x04\x56\x01\x57\x0c\xb4\x7f\x23\x8d\x2b\x02\x86\xdb\x4a\x99\x0f\xa0\xf3\xba\x28\xd1\xa3\x19\xf5\xe7\xcf\x55\xc2\xa2\x44\x4d\xa7\xcc\xc1\x36\xc1\xdc\x0c\xbe\xb9\x30\xe9\xe2\x98\x04\x35\x89\x35\x1d\x81\xd8\xe0\xbc\x73\x6a\xe2\xa1\xf5\x19\x2e\x5e\x8b\x06\x1d\x58",
};

#define SIGNATURES 3

int signatures_ok(uint8_t *store_hash)
{
	const uint32_t codelen = *((const uint32_t *)FLASH_META_CODELEN);
	const uint8_t sigindex1 = *((const uint8_t *)FLASH_META_SIGINDEX1);
	const uint8_t sigindex2 = *((const uint8_t *)FLASH_META_SIGINDEX2);
	const uint8_t sigindex3 = *((const uint8_t *)FLASH_META_SIGINDEX3);

	uint8_t hash[32];
	sha256_Raw((const uint8_t *)FLASH_APP_START, codelen, hash);
	if (store_hash) {
		memcpy(store_hash, hash, 32);
	}

	if (sigindex1 < 1 || sigindex1 > PUBKEYS) return 0; // invalid index
	if (sigindex2 < 1 || sigindex2 > PUBKEYS) return 0; // invalid index
	if (sigindex3 < 1 || sigindex3 > PUBKEYS) return 0; // invalid index

	if (sigindex1 == sigindex2) return 0; // duplicate use
	if (sigindex1 == sigindex3) return 0; // duplicate use
	if (sigindex2 == sigindex3) return 0; // duplicate use

	if (ecdsa_verify_digest(&secp256k1, pubkey[sigindex1 - 1], (const uint8_t *)FLASH_META_SIG1, hash) != 0) { // failure
		return 0;
	}
	if (ecdsa_verify_digest(&secp256k1, pubkey[sigindex2 - 1], (const uint8_t *)FLASH_META_SIG2, hash) != 0) { // failure
		return 0;
	}
	if (ecdsa_verify_digest(&secp256k1, pubkey[sigindex3 - 1], (const uint8_t *)FLASH_META_SIG3, hash) != 0) { // failture
		return 0;
	}

	return 1;
}
